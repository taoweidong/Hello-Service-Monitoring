{% extends "base.html" %}

{% block title %}服务器监控系统 - {{ server.ip_address }}{% endblock %}

{% block content %}
<!-- 页面标题和面包屑 -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">仪表板</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ server.ip_address }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">{{ server.ip_address }}</h1>
                <p class="text-muted mb-0">{{ server.hostname or 'Unknown' }}</p>
            </div>
            <div>
                <a href="{{ url_for('main.server_history', ip_address=server.ip_address) }}" class="btn btn-outline-info me-2">
                    <i class="bi bi-clock-history me-1"></i>历史数据
                </a>
                <button class="btn btn-outline-primary" id="refreshData">
                    <i class="bi bi-arrow-clockwise me-1"></i>刷新数据
                </button>
            </div>
        </div>
        <hr class="my-3">
    </div>
</div>

<!-- 服务器详细信息 -->
{% if detailed_info %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2 text-primary"></i>服务器详细信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless mb-0">
                            <tr>
                                <td style="width: 150px;"><strong>IP地址:</strong></td>
                                <td>{{ detailed_info.ip_address }}</td>
                            </tr>
                            <tr>
                                <td><strong>主机名:</strong></td>
                                <td>{{ detailed_info.hostname }}</td>
                            </tr>
                            <tr>
                                <td><strong>系统版本:</strong></td>
                                <td>{{ detailed_info.system_version }}</td>
                            </tr>
                            <tr>
                                <td><strong>内核版本:</strong></td>
                                <td>{{ detailed_info.kernel_version }}</td>
                            </tr>
                            <tr>
                                <td><strong>平台:</strong></td>
                                <td>{{ detailed_info.platform }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless mb-0">
                            <tr>
                                <td style="width: 150px;"><strong>架构:</strong></td>
                                <td>{{ detailed_info.architecture }}</td>
                            </tr>
                            <tr>
                                <td><strong>CPU核心数:</strong></td>
                                <td>{{ detailed_info.cpu_count }} (物理) / {{ detailed_info.cpu_count_logical }} (逻辑)</td>
                            </tr>
                            <tr>
                                <td><strong>总内存:</strong></td>
                                <td>{{ detailed_info.total_memory }}</td>
                            </tr>
                            <tr>
                                <td><strong>总磁盘:</strong></td>
                                <td>{{ detailed_info.total_disk }}</td>
                            </tr>
                            <tr>
                                <td><strong>运行时间:</strong></td>
                                <td>{{ detailed_info.uptime }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 服务器状态概览 -->
<div class="row g-4 mb-4" id="metricsCards">
    <!-- CPU使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">CPU使用率</h6>
                        <h3 class="mb-0" id="cpuPercent">--</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-cpu text-info fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" id="cpuProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-2">
                        <span id="cpuInfo">--</span>
                        <span id="cpuFreq">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 内存使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">内存使用率</h6>
                        <h3 class="mb-0" id="memoryPercent">--</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-memory text-warning fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" id="memoryProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-2">
                        <span id="memoryUsed">--</span>
                        <span>已用</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁盘使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">磁盘使用率</h6>
                        <h3 class="mb-0" id="diskPercent">--</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-hdd text-success fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" id="diskProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-2">
                        <span id="diskUsed">--</span>
                        <span>已用</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 趋势统计 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-3">24小时趋势统计</h6>
                <div id="trendStats">
                    <div class="small text-muted mb-2">
                        <i class="bi bi-graph-up me-1"></i>CPU: <span id="cpuAvg">--</span>%
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-graph-up me-1"></i>内存: <span id="memoryAvg">--</span>%
                    </div>
                    <div class="small text-muted">
                        <i class="bi bi-graph-up me-1"></i>磁盘: <span id="diskAvg">--</span>%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细监控图表 -->
<div class="row g-4 mb-4">
    <!-- CPU使用率趋势 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cpu me-2 text-info"></i>CPU使用率趋势
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-chart="cpu">
                            最近1小时
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="cpu" data-range="1h">最近1小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="cpu" data-range="6h">最近6小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="cpu" data-range="24h">最近24小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="cpu" data-range="7d">最近7天</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 250px;">
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="mt-3 small text-muted text-center" id="cpuStats">
                    最小值: <span id="cpuMin">--</span>% | 最大值: <span id="cpuMax">--</span>% | 平均值: <span id="cpuAvgDetail">--</span>%
                </div>
            </div>
        </div>
    </div>

    <!-- 内存使用率趋势 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-memory me-2 text-warning"></i>内存使用率趋势
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-chart="memory">
                            最近1小时
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="memory" data-range="1h">最近1小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="memory" data-range="6h">最近6小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="memory" data-range="24h">最近24小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="memory" data-range="7d">最近7天</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 250px;">
                    <canvas id="memoryChart"></canvas>
                </div>
                <div class="mt-3 small text-muted text-center" id="memoryStats">
                    最小值: <span id="memoryMin">--</span>% | 最大值: <span id="memoryMax">--</span>% | 平均值: <span id="memoryAvgDetail">--</span>%
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 磁盘和其他信息 -->
<div class="row g-4">
    <!-- 磁盘使用率趋势 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hdd me-2 text-success"></i>磁盘使用率趋势
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-chart="disk">
                            最近1小时
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="disk" data-range="1h">最近1小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="disk" data-range="6h">最近6小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="disk" data-range="24h">最近24小时</a></li>
                            <li><a class="dropdown-item chart-time-range" href="#" data-chart="disk" data-range="7d">最近7天</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 250px;">
                    <canvas id="diskChart"></canvas>
                </div>
                <div class="mt-3 small text-muted text-center" id="diskStats">
                    最小值: <span id="diskMin">--</span>% | 最大值: <span id="diskMax">--</span>% | 平均值: <span id="diskAvgDetail">--</span>%
                </div>
            </div>
        </div>
    </div>

    <!-- 综合趋势统计 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart me-2 text-primary"></i>综合趋势统计（24小时）
                </h5>
            </div>
            <div class="card-body">
                <div id="trendStatistics">
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">CPU统计</h6>
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="small text-muted">最小值</div>
                                <div class="h5 mb-0" id="trendCpuMin">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">平均值</div>
                                <div class="h5 mb-0" id="trendCpuAvg">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">最大值</div>
                                <div class="h5 mb-0" id="trendCpuMax">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">内存统计</h6>
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="small text-muted">最小值</div>
                                <div class="h5 mb-0" id="trendMemoryMin">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">平均值</div>
                                <div class="h5 mb-0" id="trendMemoryAvg">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">最大值</div>
                                <div class="h5 mb-0" id="trendMemoryMax">--</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h6 class="text-muted mb-3">磁盘统计</h6>
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="small text-muted">最小值</div>
                                <div class="h5 mb-0" id="trendDiskMin">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">平均值</div>
                                <div class="h5 mb-0" id="trendDiskAvg">--</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="small text-muted">最大值</div>
                                <div class="h5 mb-0" id="trendDiskMax">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const serverIp = '{{ server.ip_address }}';
let cpuChart = null, memoryChart = null, diskChart = null;
const chartTimeRanges = { cpu: '1h', memory: '1h', disk: '1h' };

document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    initCharts();
    
    // 加载当前数据
    loadCurrentMetrics();
    loadTrendStatistics();
    
    // 加载图表数据
    loadChartData('cpu', chartTimeRanges.cpu);
    loadChartData('memory', chartTimeRanges.memory);
    loadChartData('disk', chartTimeRanges.disk);
    
    // 时间范围选择事件
    document.querySelectorAll('.chart-time-range').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const chartType = this.getAttribute('data-chart');
            const range = this.getAttribute('data-range');
            chartTimeRanges[chartType] = range;
            
            // 更新按钮文本
            const dropdown = this.closest('.dropdown').querySelector('.dropdown-toggle');
            dropdown.textContent = this.textContent;
            
            loadChartData(chartType, range);
        });
    });
    
    // 刷新按钮事件
    document.getElementById('refreshData')?.addEventListener('click', function() {
        loadCurrentMetrics();
        loadTrendStatistics();
        loadChartData('cpu', chartTimeRanges.cpu);
        loadChartData('memory', chartTimeRanges.memory);
        loadChartData('disk', chartTimeRanges.disk);
    });
    
    // 自动刷新（每2分钟）
    setInterval(function() {
        loadCurrentMetrics();
        loadChartData('cpu', chartTimeRanges.cpu);
        loadChartData('memory', chartTimeRanges.memory);
        loadChartData('disk', chartTimeRanges.disk);
    }, 120000);
});

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function loadCurrentMetrics() {
    fetch(`/api/server/${serverIp}/current`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.warn('当前监控数据为空');
                return;
            }
            
            // 更新CPU
            if (data.cpu && data.cpu !== null) {
                const cpuPercent = parseFloat(data.cpu.cpu_percent) || 0;
                const cpuPercentEl = document.getElementById('cpuPercent');
                const cpuProgressEl = document.getElementById('cpuProgress');
                const cpuInfoEl = document.getElementById('cpuInfo');
                const cpuFreqEl = document.getElementById('cpuFreq');
                
                if (cpuPercentEl) cpuPercentEl.textContent = cpuPercent.toFixed(1) + '%';
                if (cpuProgressEl) cpuProgressEl.style.width = cpuPercent + '%';
                if (cpuInfoEl) cpuInfoEl.textContent = `${data.cpu.cpu_count || '--'} 核`;
                if (cpuFreqEl) cpuFreqEl.textContent = data.cpu.cpu_current_freq ? (data.cpu.cpu_current_freq / 1000).toFixed(2) + ' GHz' : '--';
            }
            
            // 更新内存
            if (data.memory && data.memory !== null) {
                const memoryPercent = parseFloat(data.memory.percent) || 0;
                const memoryPercentEl = document.getElementById('memoryPercent');
                const memoryProgressEl = document.getElementById('memoryProgress');
                const memoryUsedEl = document.getElementById('memoryUsed');
                
                if (memoryPercentEl) memoryPercentEl.textContent = memoryPercent.toFixed(1) + '%';
                if (memoryProgressEl) memoryProgressEl.style.width = memoryPercent + '%';
                if (memoryUsedEl && data.memory.used && data.memory.total) {
                    const usedGB = (parseFloat(data.memory.used) / (1024**3)).toFixed(2);
                    const totalGB = (parseFloat(data.memory.total) / (1024**3)).toFixed(2);
                    memoryUsedEl.textContent = `${usedGB} GB / ${totalGB} GB`;
                }
            }
            
            // 更新磁盘
            if (data.disk && data.disk !== null) {
                const diskPercent = parseFloat(data.disk.percent) || 0;
                const diskPercentEl = document.getElementById('diskPercent');
                const diskProgressEl = document.getElementById('diskProgress');
                const diskUsedEl = document.getElementById('diskUsed');
                
                if (diskPercentEl) diskPercentEl.textContent = diskPercent.toFixed(1) + '%';
                if (diskProgressEl) diskProgressEl.style.width = diskPercent + '%';
                if (diskUsedEl && data.disk.used && data.disk.total) {
                    const usedGB = (parseFloat(data.disk.used) / (1024**3)).toFixed(2);
                    const totalGB = (parseFloat(data.disk.total) / (1024**3)).toFixed(2);
                    diskUsedEl.textContent = `${usedGB} GB / ${totalGB} GB`;
                }
            }
        })
        .catch(error => {
            console.error('加载当前监控数据失败:', error);
        });
}

function loadTrendStatistics() {
    fetch(`/api/server/${serverIp}/trends?hours=24`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.warn('趋势统计信息为空');
                return;
            }
            
            // 更新趋势统计卡片
            if (data.cpu && data.cpu !== null) {
                const cpuAvgEl = document.getElementById('cpuAvg');
                const trendCpuMinEl = document.getElementById('trendCpuMin');
                const trendCpuAvgEl = document.getElementById('trendCpuAvg');
                const trendCpuMaxEl = document.getElementById('trendCpuMax');
                
                if (cpuAvgEl) cpuAvgEl.textContent = parseFloat(data.cpu.avg || 0).toFixed(1);
                if (trendCpuMinEl) trendCpuMinEl.textContent = parseFloat(data.cpu.min || 0).toFixed(1) + '%';
                if (trendCpuAvgEl) trendCpuAvgEl.textContent = parseFloat(data.cpu.avg || 0).toFixed(1) + '%';
                if (trendCpuMaxEl) trendCpuMaxEl.textContent = parseFloat(data.cpu.max || 0).toFixed(1) + '%';
            }
            if (data.memory && data.memory !== null) {
                const memoryAvgEl = document.getElementById('memoryAvg');
                const trendMemoryMinEl = document.getElementById('trendMemoryMin');
                const trendMemoryAvgEl = document.getElementById('trendMemoryAvg');
                const trendMemoryMaxEl = document.getElementById('trendMemoryMax');
                
                if (memoryAvgEl) memoryAvgEl.textContent = parseFloat(data.memory.avg || 0).toFixed(1);
                if (trendMemoryMinEl) trendMemoryMinEl.textContent = parseFloat(data.memory.min || 0).toFixed(1) + '%';
                if (trendMemoryAvgEl) trendMemoryAvgEl.textContent = parseFloat(data.memory.avg || 0).toFixed(1) + '%';
                if (trendMemoryMaxEl) trendMemoryMaxEl.textContent = parseFloat(data.memory.max || 0).toFixed(1) + '%';
            }
            if (data.disk && data.disk !== null) {
                const diskAvgEl = document.getElementById('diskAvg');
                const trendDiskMinEl = document.getElementById('trendDiskMin');
                const trendDiskAvgEl = document.getElementById('trendDiskAvg');
                const trendDiskMaxEl = document.getElementById('trendDiskMax');
                
                if (diskAvgEl) diskAvgEl.textContent = parseFloat(data.disk.avg || 0).toFixed(1);
                if (trendDiskMinEl) trendDiskMinEl.textContent = parseFloat(data.disk.min || 0).toFixed(1) + '%';
                if (trendDiskAvgEl) trendDiskAvgEl.textContent = parseFloat(data.disk.avg || 0).toFixed(1) + '%';
                if (trendDiskMaxEl) trendDiskMaxEl.textContent = parseFloat(data.disk.max || 0).toFixed(1) + '%';
            }
        })
        .catch(error => {
            console.error('加载趋势统计信息失败:', error);
        });
}

function initCharts() {
    // CPU图表
    const cpuCtx = document.getElementById('cpuChart');
    if (cpuCtx) {
        cpuChart = new Chart(cpuCtx, {
            type: 'line',
            data: { labels: [], datasets: [{
                label: 'CPU使用率 (%)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                }
            }
        });
    }
    
    // 内存图表
    const memoryCtx = document.getElementById('memoryChart');
    if (memoryCtx) {
        memoryChart = new Chart(memoryCtx, {
            type: 'line',
            data: { labels: [], datasets: [{
                label: '内存使用率 (%)',
                data: [],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.3,
                fill: true
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                }
            }
        });
    }
    
    // 磁盘图表
    const diskCtx = document.getElementById('diskChart');
    if (diskCtx) {
        diskChart = new Chart(diskCtx, {
            type: 'line',
            data: { labels: [], datasets: [{
                label: '磁盘使用率 (%)',
                data: [],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.3,
                fill: true
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                }
            }
        });
    }
}

function loadChartData(type, timeRange) {
    if (!serverIp) {
        console.warn('服务器IP为空，无法加载图表数据');
        return;
    }
    
    fetch(`/api/history/${serverIp}?range=${timeRange}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.warn(`返回的${type}数据为空`);
                return;
            }
            
            const chartData = data[type];
            if (!chartData || !chartData.labels || !Array.isArray(chartData.values)) {
                console.warn(`图表数据格式不正确:`, chartData);
                return;
            }
            
            let chart = null;
            if (type === 'cpu') chart = cpuChart;
            else if (type === 'memory') chart = memoryChart;
            else if (type === 'disk') chart = diskChart;
            
            if (chart) {
                chart.data.labels = chartData.labels;
                chart.data.datasets[0].data = chartData.values;
                chart.update();
                
                // 更新统计信息
                if (chartData.stats) {
                    const stats = chartData.stats;
                    const minEl = document.getElementById(`${type}Min`);
                    const maxEl = document.getElementById(`${type}Max`);
                    const avgEl = document.getElementById(`${type}AvgDetail`);
                    
                    if (minEl) minEl.textContent = parseFloat(stats.min || 0).toFixed(2) + '%';
                    if (maxEl) maxEl.textContent = parseFloat(stats.max || 0).toFixed(2) + '%';
                    if (avgEl) avgEl.textContent = parseFloat(stats.avg || 0).toFixed(2) + '%';
                }
            }
        })
        .catch(error => {
            console.error(`加载${type}图表数据失败:`, error);
        });
}
</script>
{% endblock %}
