{% extends "base.html" %}

{% block title %}服务器监控系统 - 仪表板{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">仪表板</h1>
            <button class="btn btn-outline-primary" id="refreshDashboard">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新数据
            </button>
        </div>
        <hr class="my-3">
    </div>
</div>

<!-- 统计概览 -->
<div class="row g-4 mb-4" id="overviewCards">
    <!-- 服务器数量 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">服务器数量</h6>
                        <h3 class="mb-0" id="serverCount">{{ servers_with_metrics|length }}</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-server text-primary fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="text-success small">
                        <i class="bi bi-arrow-up-circle me-1"></i>在线
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 平均CPU使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">平均CPU使用率</h6>
                        <h3 class="mb-0" id="avgCpuPercent">--</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-cpu text-info fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" id="avgCpuProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 平均内存使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">平均内存使用率</h6>
                        <h3 class="mb-0" id="avgMemoryPercent">--</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-memory text-warning fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="avgMemoryProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 平均磁盘使用率 -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">平均磁盘使用率</h6>
                        <h3 class="mb-0" id="avgDiskPercent">--</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-hdd text-success fs-4"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" id="avgDiskProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 服务器列表和图表 -->
<div class="row g-4">
    <!-- 服务器列表 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hdd-network me-2 text-primary"></i>服务器列表
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshServers">
                        <i class="bi bi-arrow-repeat me-1"></i>刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if servers_with_metrics %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>IP地址</th>
                                <th>主机名</th>
                                <th>CPU</th>
                                <th>内存</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in servers_with_metrics %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">{{ item.server.ip_address }}</span>
                                </td>
                                <td>{{ item.server.hostname or 'Unknown' }}</td>
                                <td>
                                    {% if item.metrics and item.metrics.cpu and item.metrics.cpu.cpu_percent is not none %}
                                    <span class="badge {% if item.metrics.cpu.cpu_percent > 80 %}bg-danger{% elif item.metrics.cpu.cpu_percent > 60 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ "%.1f"|format(item.metrics.cpu.cpu_percent) }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.metrics and item.metrics.memory and item.metrics.memory.percent is not none %}
                                    <span class="badge {% if item.metrics.memory.percent > 80 %}bg-danger{% elif item.metrics.memory.percent > 60 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ "%.1f"|format(item.metrics.memory.percent) }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-success-subtle text-success">
                                        <i class="bi bi-circle-fill me-1"></i>在线
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('main.server_detail', ip_address=item.server.ip_address) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-graph-up me-1"></i>详情
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-server text-muted fs-1 mb-3"></i>
                    <h6 class="text-muted">暂无服务器数据</h6>
                    <p class="text-muted small">系统正在后台自动采集数据</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 系统资源趋势图表 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart-line me-2 text-primary"></i>系统资源趋势
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="timeRangeDropdown" data-bs-toggle="dropdown">
                            最近1小时
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item time-range" href="#" data-range="1h">最近1小时</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="6h">最近6小时</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="24h">最近24小时</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="7d">最近7天</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="resourceChart"></canvas>
                    <div id="chartLoading" class="text-center py-5 position-absolute top-50 start-50 translate-middle" style="display: none; z-index: 10; background-color: rgba(255, 255, 255, 0.9); width: 100%; height: 100%;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="text-muted mt-2">正在加载数据...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// 初始化资源趋势图表
let resourceChart = null;
let currentTimeRange = '1h';
let currentServerIp = '';

document.addEventListener('DOMContentLoaded', function() {
    // 计算平均指标
    updateAverageMetrics();
    
    // 初始化图表
    initResourceChart();
    
    // 如果有服务器，加载第一个服务器的数据
    try {
        const servers = {{ servers_with_metrics|tojson if servers_with_metrics else '[]'|safe }};
        if (servers && servers.length > 0 && servers[0].server && servers[0].server.ip_address) {
            currentServerIp = servers[0].server.ip_address;
            // 延迟一点加载，确保图表已初始化
            setTimeout(() => {
                loadChartData(currentServerIp, currentTimeRange);
            }, 100);
        } else {
            console.warn('没有可用的服务器数据');
        }
    } catch (e) {
        console.error('初始化服务器IP失败:', e);
    }
    
    // 时间范围选择事件
    document.querySelectorAll('.time-range').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            currentTimeRange = this.getAttribute('data-range');
            document.getElementById('timeRangeDropdown').textContent = this.textContent;
            loadChartData(currentServerIp, currentTimeRange);
        });
    });
    
    // 刷新按钮事件
    document.getElementById('refreshDashboard')?.addEventListener('click', function() {
        location.reload();
    });
    
    document.getElementById('refreshServers')?.addEventListener('click', function() {
        location.reload();
    });
    
    // 自动刷新数据（每2分钟）
    setInterval(function() {
        updateAverageMetrics();
        if (currentServerIp) {
            loadChartData(currentServerIp, currentTimeRange);
        }
    }, 120000);
});

function updateAverageMetrics() {
    // 计算所有服务器的平均指标
    let servers = [];
    try {
        servers = {{ servers_with_metrics|tojson if servers_with_metrics else '[]'|safe }};
    } catch (e) {
        console.error('解析服务器数据失败:', e);
        servers = [];
    }
    
    if (!servers || servers.length === 0) {
        // 如果没有数据，显示默认值
        document.getElementById('avgCpuPercent').textContent = '--';
        document.getElementById('avgMemoryPercent').textContent = '--';
        document.getElementById('avgDiskPercent').textContent = '--';
        document.getElementById('avgCpuProgress').style.width = '0%';
        document.getElementById('avgMemoryProgress').style.width = '0%';
        document.getElementById('avgDiskProgress').style.width = '0%';
        return;
    }
    
    let totalCpu = 0, totalMemory = 0, totalDisk = 0;
    let cpuCount = 0, memoryCount = 0, diskCount = 0;
    
    servers.forEach(item => {
        if (item && item.metrics) {
            if (item.metrics.cpu && item.metrics.cpu !== null && item.metrics.cpu.cpu_percent !== null && item.metrics.cpu.cpu_percent !== undefined) {
                totalCpu += parseFloat(item.metrics.cpu.cpu_percent) || 0;
                cpuCount++;
            }
            if (item.metrics.memory && item.metrics.memory !== null && item.metrics.memory.percent !== null && item.metrics.memory.percent !== undefined) {
                totalMemory += parseFloat(item.metrics.memory.percent) || 0;
                memoryCount++;
            }
            if (item.metrics.disk && item.metrics.disk !== null && item.metrics.disk.percent !== null && item.metrics.disk.percent !== undefined) {
                totalDisk += parseFloat(item.metrics.disk.percent) || 0;
                diskCount++;
            }
        }
    });
    
    const avgCpu = cpuCount > 0 ? (totalCpu / cpuCount).toFixed(1) : '--';
    const avgMemory = memoryCount > 0 ? (totalMemory / memoryCount).toFixed(1) : '--';
    const avgDisk = diskCount > 0 ? (totalDisk / diskCount).toFixed(1) : '--';
    
    const avgCpuEl = document.getElementById('avgCpuPercent');
    const avgMemoryEl = document.getElementById('avgMemoryPercent');
    const avgDiskEl = document.getElementById('avgDiskPercent');
    
    if (avgCpuEl) avgCpuEl.textContent = avgCpu !== '--' ? avgCpu + '%' : '--';
    if (avgMemoryEl) avgMemoryEl.textContent = avgMemory !== '--' ? avgMemory + '%' : '--';
    if (avgDiskEl) avgDiskEl.textContent = avgDisk !== '--' ? avgDisk + '%' : '--';
    
    const avgCpuProgress = document.getElementById('avgCpuProgress');
    const avgMemoryProgress = document.getElementById('avgMemoryProgress');
    const avgDiskProgress = document.getElementById('avgDiskProgress');
    
    if (avgCpuProgress) avgCpuProgress.style.width = avgCpu !== '--' ? avgCpu + '%' : '0%';
    if (avgMemoryProgress) avgMemoryProgress.style.width = avgMemory !== '--' ? avgMemory + '%' : '0%';
    if (avgDiskProgress) avgDiskProgress.style.width = avgDisk !== '--' ? avgDisk + '%' : '0%';
}

function initResourceChart() {
    const ctx = document.getElementById('resourceChart');
    if (!ctx) {
        console.error('无法找到图表canvas元素');
        return;
    }
    
    try {
        resourceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU使用率 (%)',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0, // 不显示点，只显示线
                        pointHoverRadius: 3
                    },
                    {
                        label: '内存使用率 (%)',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 3
                    },
                    {
                        label: '磁盘使用率 (%)',
                        data: [],
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0 // 禁用动画，加快数据更新
                },
                plugins: {
                    legend: {
                        position: 'top',
                        display: true
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                }
            }
        });
        console.log('资源趋势图表初始化成功');
    } catch (e) {
        console.error('初始化资源趋势图表失败:', e);
    }
}

function loadChartData(ipAddress, timeRange) {
    if (!ipAddress) {
        console.warn('服务器IP地址为空，无法加载图表数据');
        // 不显示空数据提示，因为没有服务器
        hideChartPlaceholders();
        return;
    }
    
    if (!resourceChart) {
        console.warn('图表未初始化，无法加载数据');
        return;
    }
    
    // 显示加载状态
    const loadingEl = document.getElementById('chartLoading');
    const emptyEl = document.getElementById('chartEmpty');
    if (loadingEl) loadingEl.style.display = 'block';
    if (emptyEl) emptyEl.style.display = 'none';
    
    fetch(`/api/history/${ipAddress}?range=${timeRange}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.warn('返回的数据为空');
                hideChartPlaceholders();
                return;
            }
            
            let hasData = false;
            
            // 处理CPU数据
            if (data.cpu && data.cpu.labels && data.cpu.values && Array.isArray(data.cpu.values) && data.cpu.values.length > 0) {
                resourceChart.data.labels = data.cpu.labels;
                resourceChart.data.datasets[0].data = data.cpu.values;
                hasData = true;
            } else {
                resourceChart.data.datasets[0].data = [];
            }
            
            // 处理内存数据
            if (data.memory && data.memory.values && Array.isArray(data.memory.values) && data.memory.values.length > 0) {
                resourceChart.data.datasets[1].data = data.memory.values;
                hasData = true;
            } else {
                resourceChart.data.datasets[1].data = [];
            }
            
            // 处理磁盘数据
            if (data.disk && data.disk.values && Array.isArray(data.disk.values) && data.disk.values.length > 0) {
                resourceChart.data.datasets[2].data = data.disk.values;
                hasData = true;
            } else {
                resourceChart.data.datasets[2].data = [];
            }
            
            // 如果没有标签，创建一个默认的时间标签序列
            if (!resourceChart.data.labels || resourceChart.data.labels.length === 0) {
                resourceChart.data.labels = [];
            }
            
            // 隐藏加载状态
            const loadingEl = document.getElementById('chartLoading');
            const emptyEl = document.getElementById('chartEmpty');
            if (loadingEl) loadingEl.style.display = 'none';
            if (emptyEl) emptyEl.style.display = 'none';
            
            if (hasData) {
                resourceChart.update('none'); // 使用'none'模式更新，避免动画闪烁
            } else {
                // 只有在所有数据都为空且服务器存在时才显示空数据提示
                console.warn('图表数据为空或格式不正确，但继续显示图表框架');
                // 不显示空数据提示，让图表保持空白状态即可
                resourceChart.update('none');
            }
        })
        .catch(error => {
            console.error('加载图表数据失败:', error);
            hideChartPlaceholders();
            // 出错时不显示空数据提示，保持图表可见（可能只是网络问题）
        });
}

function hideChartPlaceholders() {
    // 隐藏所有占位符（加载和空数据提示），只显示图表
    const loadingEl = document.getElementById('chartLoading');
    const emptyEl = document.getElementById('chartEmpty');
    if (loadingEl) loadingEl.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'none';
}
</script>
{% endblock %}
