{% extends "base.html" %}

{% block title %}服务器监控系统 - 历史数据{% endblock %}

{% block content %}
<!-- 页面标题和面包屑 -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">仪表板</a></li>
                <li class="breadcrumb-item"><a href="/server/{{ server.ip_address }}">{{ server.ip_address }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">历史数据</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">{{ server.ip_address }} - 历史数据</h1>
                <p class="text-muted mb-0">{{ server.hostname }}</p>
            </div>
            <button class="btn btn-outline-primary" id="refreshData">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新数据
            </button>
        </div>
        <hr class="my-3">
    </div>
</div>

<!-- 时间范围选择 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2 text-primary"></i>时间范围
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm time-range active" data-range="1h">1小时</button>
                        <button type="button" class="btn btn-outline-primary btn-sm time-range" data-range="6h">6小时</button>
                        <button type="button" class="btn btn-outline-primary btn-sm time-range" data-range="24h">24小时</button>
                        <button type="button" class="btn btn-outline-primary btn-sm time-range" data-range="7d">7天</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 历史数据图表 -->
<div class="row g-4">
    <!-- CPU使用率历史 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cpu me-2 text-info"></i>CPU使用率历史
                    </h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="cpuHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 内存使用率历史 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-memory me-2 text-warning"></i>内存使用率历史
                    </h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="memoryHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁盘使用率历史 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hdd me-2 text-success"></i>磁盘使用率历史
                    </h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="diskHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 资源使用率对比 -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2 text-primary"></i>资源使用率对比
                    </h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 历史数据表格 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2 text-primary"></i>详细历史数据
                    </h5>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>时间</th>
                                <th>CPU使用率</th>
                                <th>内存使用率</th>
                                <th>磁盘使用率</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    // 获取服务器IP地址
    const ipAddress = "{{ server.ip_address }}";
    
    // 初始化CPU历史图表
    const cpuHistoryCtx = document.getElementById('cpuHistoryChart').getContext('2d');
    const cpuHistoryChart = new Chart(cpuHistoryCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU使用率 (%)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });

    // 初始化内存历史图表
    const memoryHistoryCtx = document.getElementById('memoryHistoryChart').getContext('2d');
    const memoryHistoryChart = new Chart(memoryHistoryCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '内存使用率 (%)',
                data: [],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });

    // 初始化磁盘历史图表
    const diskHistoryCtx = document.getElementById('diskHistoryChart').getContext('2d');
    const diskHistoryChart = new Chart(diskHistoryCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '磁盘使用率 (%)',
                data: [],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });

    // 初始化对比图表
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: ['CPU使用率', '内存使用率', '磁盘使用率'],
            datasets: [{
                label: '平均使用率 (%)',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(25, 135, 84, 0.7)'
                ],
                borderColor: [
                    'rgba(13, 110, 253, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // 加载历史数据
    function loadHistoryData(range = '1h') {
        fetch(`/api/history/${ipAddress}?range=${range}`)
            .then(response => response.json())
            .then(data => {
                // 更新CPU图表
                cpuHistoryChart.data.labels = data.cpu.map(item => formatTime(item.timestamp));
                cpuHistoryChart.data.datasets[0].data = data.cpu.map(item => item.cpu_percent);
                cpuHistoryChart.update();

                // 更新内存图表
                memoryHistoryChart.data.labels = data.memory.map(item => formatTime(item.timestamp));
                memoryHistoryChart.data.datasets[0].data = data.memory.map(item => item.percent);
                memoryHistoryChart.update();

                // 更新磁盘图表
                diskHistoryChart.data.labels = data.disk.map(item => formatTime(item.timestamp));
                diskHistoryChart.data.datasets[0].data = data.disk.map(item => item.percent);
                diskHistoryChart.update();

                // 计算平均值并更新对比图表
                const avgCpu = calculateAverage(data.cpu.map(item => item.cpu_percent));
                const avgMemory = calculateAverage(data.memory.map(item => item.percent));
                const avgDisk = calculateAverage(data.disk.map(item => item.percent));
                
                comparisonChart.data.datasets[0].data = [avgCpu, avgMemory, avgDisk];
                comparisonChart.update();

                // 更新表格数据
                updateHistoryTable(data);
            })
            .catch(error => {
                console.error('加载历史数据失败:', error);
            });
    }

    // 格式化时间
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    // 计算平均值
    function calculateAverage(data) {
        if (data.length === 0) return 0;
        const sum = data.reduce((acc, value) => acc + value, 0);
        return Math.round(sum / data.length * 100) / 100;
    }

    // 更新历史数据表格
    function updateHistoryTable(data) {
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = '';

        // 找到最长的数据集
        const maxLength = Math.max(data.cpu.length, data.memory.length, data.disk.length);
        
        for (let i = 0; i < maxLength; i++) {
            const row = document.createElement('tr');
            
            // 时间
            const timeCell = document.createElement('td');
            if (data.cpu[i]) {
                timeCell.textContent = formatTime(data.cpu[i].timestamp);
            } else if (data.memory[i]) {
                timeCell.textContent = formatTime(data.memory[i].timestamp);
            } else if (data.disk[i]) {
                timeCell.textContent = formatTime(data.disk[i].timestamp);
            }
            row.appendChild(timeCell);

            // CPU使用率
            const cpuCell = document.createElement('td');
            if (data.cpu[i]) {
                cpuCell.textContent = `${data.cpu[i].cpu_percent.toFixed(2)}%`;
            } else {
                cpuCell.textContent = '-';
            }
            row.appendChild(cpuCell);

            // 内存使用率
            const memoryCell = document.createElement('td');
            if (data.memory[i]) {
                memoryCell.textContent = `${data.memory[i].percent.toFixed(2)}%`;
            } else {
                memoryCell.textContent = '-';
            }
            row.appendChild(memoryCell);

            // 磁盘使用率
            const diskCell = document.createElement('td');
            if (data.disk[i]) {
                diskCell.textContent = `${data.disk[i].percent.toFixed(2)}%`;
            } else {
                diskCell.textContent = '-';
            }
            row.appendChild(diskCell);

            tableBody.appendChild(row);
        }
    }

    // 时间范围选择事件
    document.querySelectorAll('.time-range').forEach(button => {
        button.addEventListener('click', function() {
            // 移除所有按钮的active类
            document.querySelectorAll('.time-range').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 添加当前按钮的active类
            this.classList.add('active');
            
            // 加载对应时间范围的数据
            loadHistoryData(this.dataset.range);
        });
    });

    // 刷新按钮事件
    document.getElementById('refreshData').addEventListener('click', function() {
        const activeRange = document.querySelector('.time-range.active');
        const range = activeRange ? activeRange.dataset.range : '1h';
        loadHistoryData(range);
    });

    // 初始加载数据
    loadHistoryData('1h');
});
</script>
{% endblock %}